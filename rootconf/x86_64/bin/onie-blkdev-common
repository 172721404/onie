
onie_boot_mnt="/mnt/onie-boot"
onie_config_mnt="/mnt/onie-config"

# gfdisk types and GPT UUIDs from gptfdisk-0.8.8/parttypes.cc
grub_boot_gfdisk_type="0xEF02"
onie_boot_gfdisk_type="0x3100"
onie_config_gfdisk_type="0x3101"

grub_boot_gpt_uuid="21686148-6449-6E6F-744E-656564454649"
onie_boot_gpt_uuid="7412F7D5-A156-4B13-81DC-867174929325"
onie_config_gpt_uuid="D4E6E2CD-4469-46F3-B5CB-1BFF57AFC149"

onie_boot_fs_type="ext4"
onie_config_fs_type="ext4"

grub_boot_label="GRUB-BOOT"
onie_boot_label="ONIE-BOOT"
onie_config_label="ONIE-CONFIG"

onie_umount_partitions()
{
    umount $onie_boot_mnt > /dev/null 2>&1
    umount $onie_config_mnt > /dev/null 2>&1
    rm -rf $_tmp_mnt
}

# Find the ONIE partitions.
#
# When this function returns success the following variables are set:
#
#   onie_boot_dev   -- block device for the ONIE-BOOT partition
#   onie_config_dev -- block device for the ONIE-CONFIG partition
onie_find_partitions()
{
    for label in ONIE-BOOT ONIE-CONFIG ; do
        # Sanity check
        num_parts="$(blkid | grep $label | wc -l)"
        if [ $num_parts -ne 1 ] ; then
            echo "ERROR: Unable to determine $label disk label"
            echo "Found $num_parts total partitions with that label"
            return 1
        fi
        dev=$(blkid | grep $label | sed -e 's/://' | awk '{print $1}')
        if [ ! -b "$dev" ] ; then
            echo "ERROR: ONIE device does not look like a block device: $dev"
            return 1
        fi
        case "$label" in
            ONIE-BOOT)
                onie_boot_dev="$dev"
                ;;
            ONIE-CONFIG)
                onie_config_dev="$dev"
                ;;
            *)
                echo "ERROR: Unknown label"
                return 1
                ;;
        esac
    done

    return 0
}

# Find and mount the ONIE partitions.
#
# When this function returns success the ONIE partitions are mounted
# and the following variables are set:
#
#   onie_boot_dev   -- block device for the ONIE-BOOT partition
#   onie_boot_mnt   -- filesystem mount point for the ONIE-BOOT partition (read-only)
#   onie_config_dev -- block device for the ONIE-CONFIG partition
#   onie_config_mnt -- filesystem mount point for the ONIE-CONFIG partition (read-write)
onie_mount_partitions()
{
    onie_find_partitions || {
        echo "ERROR: Unable to locate the ONIE partitions"
        return 1
    }

    _tmp_mnt=$(mktemp -d)
    onie_boot_mnt="$_tmp_mnt/boot"
    onie_config_mnt="$_tmp_mnt/config"

    trap onie_umount_partitions EXIT

    mkdir -p $onie_boot_mnt
    mount -o defaults,ro -t $onie_boot_fs_type $onie_boot_dev $onie_boot_mnt || {
        echo "ERROR: Problems mounting $onie_boot_dev on $onie_boot_mnt"
        exit 1
    }

    mkdir -p $onie_config_mnt
    mount -o defaults,rw -t $onie_config_fs_type $onie_config_dev $onie_config_mnt || {
        echo "ERROR: Problems mounting $onie_config_dev on $onie_config_mnt"
        exit 1
    }

    return 0
}

# Local Variables:
# mode: shell-script
# eval: (sh-set-shell "/bin/sh" t nil)
# End:
