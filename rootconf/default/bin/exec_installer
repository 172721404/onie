#!/bin/sh

. /scripts/functions
syslog_tag=onie-exec

run_installer()
{
    [ -r $onie_installer ] || {
        log_failure_msg "Unable to find installer: $onie_installer"
        return 1
    }

    export onie_exec_url="$1"
    # escape any % characters for printing with printf
    print_exec_url=$(echo -n $onie_exec_url | sed -e 's/%/%%/g')
    log_console_msg "Executing installer: $print_exec_url"
    if [ "$onie_boot_reason" = "update" ] ; then
        grep -q ONIE-UPDATER-COOKIE $onie_installer || {
            log_failure_msg "ONIE Updater:  Invalid ONIE update image format."
            return 1
        }
    fi

    chmod +x $onie_installer
    # Send installer execution output to the console
    { $onie_installer; echo "$?" > /var/run/install.rc; } 2>&1 | tee /dev/console | logger $log_stderr -t os-install -p ${syslog_onie}.info
    [ "$(cat /var/run/install.rc)" = "0" ] && reboot && return 0

    # installer should not return
    return 1
}

# wget HTTP/FTP download helper
wget_run()
{
    type=$1
    URL="$2"

    wget_args="-T 3 -O $onie_installer"

    if [ "$onie_verbose" = "y" ]; then
        out_file="/proc/$$/fd/1"
    else
        wget_args="$wget_args -q"
        out_file="/dev/null"
    fi

    # add HTTP headers
    # Shell variable substituion
    bb_ver=$(busybox | head -1 | sed -e 's/ (.*//' -e 's/ /-/')
    os_ver=$(uname -r -s | sed -e 's/ /-/')
    user_agent="-U onie/1.0 ($os_ver; $bb_ver)"

    header_serial_num="ONIE-SERIAL-NUMBER: $onie_serial_num"
    header_eth_addr="ONIE-ETH-ADDR: $onie_eth_addr"
    header_vendor_id="ONIE-VENDOR-ID: $onie_vendor_id"
    header_machine="ONIE-MACHINE: $onie_machine"
    header_arch="ONIE-ARCH: $onie_arch"
    header_security_key="ONIE-SECURITY-KEY: $onie_sec_key"
    header_operation="ONIE-OPERATION: $onie_operation"

    log_debug_msg "Running wget with: $user_agent $wget_args $URL\n"
    echo "Info: Fetching $URL ..."
    wget "$user_agent" $wget_args       \
        --header "$header_serial_num"   \
        --header "$header_eth_addr"     \
        --header "$header_vendor_id"    \
        --header "$header_machine"      \
        --header "$header_arch"         \
        --header "$header_security_key" \
        --header "$header_operation"    \
        "$URL" > $out_file 2>&1 && run_installer "$URL" && return 0

    return 1
}

# TFTP download helper
tftp_run()
{
    SERVER=$1
    BOOTFILE=$2

    URL="tftp://$SERVER/$BOOTFILE"
    log_debug_msg "Running tftp get with: server: $SERVER, bootfile: $BOOTFILE"
    log_info_msg "Fetching $URL ..."
    if [ "$onie_verbose" = "y" ]; then
        tftp -g -l $onie_installer -r $BOOTFILE $SERVER && run_installer "$URL" && return 0
    else
        tftp -g -l $onie_installer -r $BOOTFILE $SERVER > /dev/null 2>&1 && run_installer "$URL" && return 0
    fi

    return 1
}

# Try possible URL handlers
# URL could be:
#   http://
#   ftp://
#   file://
#   tftp://
url_run()
{
    URL="$1"
    quiet=$2
    url_type=${URL%%:*}
    url_path=${URL##*://}
    rm -f $onie_installer
    case $url_type in
        http | https | ftp)
            wget_run $url_type "$URL" && return 0
            ;;
        tftp)
            server=${url_path%%/*}
            path=${url_path#*/}
            tftp_run $server $path && return 0
            ;;
        *)
            [ -n "$quiet" ] || log_failure_msg "Unknown URL type: $URL"
            ;;
    esac

    return 1
}

# Try various HTTP URLs
http_download()
{
    # Try neighbors
    while [ ${#onie_neighs} -gt 0 ] ; do
        n=${onie_neighs%%,*}
        onie_neighs=${onie_neighs#*,}
        tmp=$(echo $n | sed -e 's/-/%/g');
        url_run "http://$tmp/$onie_default_filename" && return 0
    done

    # Try bootfile as a URL, supress warnings
    if [ -n "$onie_disco_boot_file" ] ; then
        url_run "$onie_disco_boot_file" quiet && return 0
    fi

    return 1
}

tftp_download()
{
    # Try BOOTP next-server and boot_file
    if [ -n "$onie_disco_siaddr" ] && [ -n "$onie_disco_boot_file" ] ; then
        url_run "tftp://$onie_disco_siaddr/$onie_disco_boot_file" && return 0
    fi

    # Try DHCP TFTP server name (opt 67) and boot_file
    # Requires DNS
    if [ -n "$onie_disco_tftp" ] && [ -n "$onie_disco_boot_file" ] ; then
        url_run "tftp://$onie_disco_tftp/$onie_disco_boot_file" && return 0
    fi

    return 1
}

waterfall()
{
    # Build list of waterfall paths

    wf_paths=
    # First is based on MAC address
    [ -n "$onie_eth_addr" ] && wf_paths="$(echo $onie_eth_addr | sed -e 's/:/-/g')/$onie_default_filename"

    if [ -n "$onie_disco_ip" ] ; then
        # Next 8 are based on IP address in HEX:
        tmp=$(echo $onie_disco_ip | sed -e 's/\./ /g')
        cmd="printf %02X%02X%02X%02X $tmp"
        wf_ip=$(eval $cmd)
        len=8
        while [ $len -gt 0 ] ; do
            wf_paths="$wf_paths $(echo $wf_ip | head -c $len)/$onie_default_filename"
            len=$(( $len - 1 ))
        done
    fi

    # Next is root of tftp server
    wf_paths="$wf_paths $onie_default_filename"
    
    # HTTP server IP waterfall
    if [ -n "$onie_disco_wwwsrv" ] ; then
        for p in $wf_paths ; do
            url_run "http://$onie_disco_wwwsrv/$p" && return 0
        done
    fi
    
    # TFTP waterfall
    if [ -n "$onie_disco_siaddr" ] ; then
        for p in $wf_paths ; do
            url_run "tftp://$onie_disco_siaddr/$p" && return 0
        done
    fi

    return 1
}

local_fs_run()
{
    mp=$(mktemp -d)
    while [ ${#onie_local_parts} -gt 0 ] ; do
        p=${onie_local_parts%%,*}
        onie_local_parts=${onie_local_parts#*,}
        mount $p $mp > /dev/null 2>&1 && {
            if [ -r $mp/$onie_default_filename ] ; then
                # copy to /tmp, which is a tmpfs -- installer needs to
                # run with everything unmounted.
                tmp_copy=$(mktemp -p /tmp)
                cp $mp/$onie_default_filename $tmp_copy || {
                    log_failure_msg "local_fs_run():$p Unable to copy $onie_default_filename to tmpfs"
                    rm -f $tmp_copy
                    return 1
                }
                sync ; sync
                umount $p
                ln -sf $tmp_copy $onie_installer || {
                    log_failure_msg "local_fs_run():$p Unable to make symlink to $onie_installer in tmpfs"
                    rm -f $tmp_copy
                    return 1
                }
                run_installer "file:/$p/$onie_default_filename" && return 0
                rm -f $tmp_copy $onie_installer
            else
                umount $p
            fi
        }
    done
    rm -rf $mp

    return 1
}

##
## Script starts here
##

parm_file="$1"
[ -r $parm_file ] || {
    log_failure_msg "Unable to read parameter file: $parm_file"
    log_console_msg "FATAL: Unable to read parameter file: $parm_file"
    exit 1
}
parms="$(cat $parm_file)"

import_parms "$parms"
rm -f $onie_installer

# Try static installer URL from CLI
if [ -n "$onie_cli_static_url" ] ; then
    # also send to stdout of current process
    tee_log_file=/proc/$$/fd/1
    url_run "$onie_cli_static_url" && exit 0
    # stop here if it didn't work
    exit 1
fi

# Try static updater URL from CLI
if [ -n "$onie_cli_static_update_url" ] ; then
    # also send to stdout of current process
    tee_log_file=/proc/$$/fd/1
    url_run "$onie_cli_static_update_url" && exit 0
    # stop here if it didn't work
    exit 1
fi

# Next try static URL from u-boot
if [ -n "$onie_static_url" ] ; then
    url_run "$onie_static_url" && exit 0
fi

# Next try locally attached filesystems
if [ -n "$onie_local_parts" ] ; then
    local_fs_run && exit 0
fi

# Next try exactly discovered URLs
if [ -n "$onie_disco_onie_url" ] ; then
    url_run "$onie_disco_onie_url" && exit 0
fi

if [ -n "$onie_disco_url" ] ; then
    url_run "$onie_disco_url" && exit 0
fi

# Try HTTP discovery methods next
http_download && {
    echo "http success, exiting..."
    exit 0
}

# Try TFTP discovery methods next
tftp_download && {
    echo "tftp success, exiting..."
    exit 0
}

# Finally try HTTP/TFTP waterfall methods
waterfall && {
    echo "waterfall success, exiting..."
    exit 0
}

exit 1

# Local Variables:
# mode: shell-script
# eval: (sh-set-shell "/bin/sh" t nil)
# End:
